---
title: Kubernetes
date: 2022-10-03 12:49:53
tags:
---

# [英文版](../../../../2023/09/01/week-53/)

Kubernetes 是基于 Docker 的开源容器集群管理系统，运行在操作系统之上并与`Pod`进行交互，目标是通过声明式配置和自动化来管理跨多个主机的容器集群。

用户的工作在于配置 K8S，定义`Node`，`Pod`以及容器，K8S 负责提供自动部署、回滚、存储编排、资源分配、配置管理、服务发现、负载均衡和自我修复。

# Pod

一个`Pod`由一组容器化应用构成，构成了一个应用所在的逻辑主机。`Pod`是 K8S 进行创建，编排及管理的最小单位，通常由 K8S 工作负载所创建，而非由用户直接创建。`Pod`被设计为是一次性可替代的组件，一旦一个`Pod`被创建后就不可以添加或删除容器，而是应该删除`Pod`并替换为一个新的`Pod`。

一个`Pod`中的一组容器是紧密耦合的，拥有相同的资源上下文（配置，命名空间，卷，网络等），K8S 通过`Pod`的 DNS/IP 来暴露一个`Pod`。一个`Pod`中的一组容器可以通过`localhost`来互相通信，但是当和`Pod`外部通信时，`Pod`内的容器需要协调如何共享网络资源（比如端口号）。

`services`是`Pod`对外的逻辑抽象，自动将服务请求发送到正确的`Pod`（无论它在集群中的位置，或者它是否被替换），提供对外访问`Pod`容器组的策略。

# Node

K8S 会为`Pod`分配工作机器来在 Linux 环境中执行具体的容器集群调度处理工作，工作机器（虚拟机或者物理机）就称为`Node`，`Node`包含了能够运行 Docker 容器所用到的服务，每个`Node`都运行了一些`Pods`，一组`Node`会构成一个 K8S 集群。

`Node`组件会在每个`Node`上运行，负责维护运行的`Pod`并提供 K8S 运行环境。

- kubelet 是负责保证容器都处于运行状态且健康的`Node`组件，会在集群中每个节点上运行

- kube-proxy 是负责维护节点上的网络规则的`Node`组件，是集群中每个节点上运行的网络代理，它锁维护的网络规则会允许从集群内部或外部的网络会话与`Pod`进行网络通信

- 容器运行时是负责运行容器的`Node`组件，docker 就是一个容器运行时，一个`Node`至少要有一个容器运行时，节点上的 kubelet 会指导容器运行时去创建指定的容器。

  

# 控制平面

控制平面指容器编排层，会为集群做出全局决策，以及定义、部署和管理集群。控制平面可以在集群中的任何节点上运行。在生产环境中，控制平面通常跨多台计算机运行，一个集群通常运行多个节点，提供容错性和高可用性。

控制面的核心是 API 服务器，API 服务器负责提供 HTTP API，以供用户、集群中的不同部分和集群外部组件互相通信，可用于查询和操纵 K8S API 中对象（例如：Pod、Namespace、ConfigMap 和 Event）的状态。K8S 支持多个 API 版本，每个版本都被称为 API 组，这些 API 组可以被启用或者禁用，在集群升级时需要注意API是否存在不兼容的变更。

- kube-apiserver 是负责处理接收请求的前端控制平面组件，是 API 服务器的主要实现，可以通过运行更多的 kube-apiserver 实例来实现请求的负载均衡

- kube-scheduler 是负责监视新创建的 Pod 及资源调度决策的控制平面组件

- kube-controller-manager 是负责运行控制器进程的控制平面组件，包括 endpoint-controller（刷新服务和 pod 的关联信息）和 replication-controller（负责指定数量的`Pod`在同一时间一起运行）

- cloud-controller-manager 是负责运行特定于云平台的控制器进程的控制平面组件。

  

# 插件

插件使用 K8S 资源实现集群功能，并非严格意义上的必需组件。

- DNS 是负责为 K8S 服务提供 DNS 记录的插件
- Dashboard 是负责提供通用的、基于 Web 用户界面的插件
- 容器资源监控是负责将关于容器的常见的时间序列度量值保存并提供浏览界面的插件
- 集群层面日志是负责将容器的日志数据保存并提供搜索和浏览的插件

# Kubernetes 对象

在 K8S 系统中，K8S 对象是持久化的状态，这些实体描述了哪些容器化应用正在运行，可以被应用使用的资源，以及关于应用运行时表现的策略。K8S 使用这些实体去表示整个集群的状态，并通过控制平面始终管理对象的状态使之达到期望状态。

整个 K8S 对象包含两个嵌套的对象字段：`spec`和`status`（分别代表规约和状态）。对于具有`spec`的对象，必须在创建时设置其内容，描述希望对象所具有的特征，其期望状态，从而告知 K8S 系统想要的集群工作负载状态。

K8S 可以直接创建或者通过 kubectl（命令行接口）来创建对象。kubectl 支持多种不同的方式来创建和管理 K8S 对象，但应只用一种技术来管理对象，混合和匹配技术作用在同一对象上将导致未定义行为。

在 K8S 集群的整个生命周期中创建的每个对象都一个不同的 UID，用于标识对象在这个集群中的唯一性。

名字空间是提供同一集群中的资源划分为互相隔离的组的机制，同一名字空间内的资源名要唯一，但跨名字空间时没有这个要求。不必使用多个名字空间来分隔仅仅轻微不同的资源，例如同一软件的不同版本（可以使用标签）。

标签是附加到 K8S 对象上的键值对，用于指定对用户有意义且相关的对象的标识属性，用于组织和选择对象的子集，能够高效地查询和监听，使用户能够以松散耦合的方式将它们组即的组织结构映射到系统对象，而无需客户端存储这些映射。

与名称和 UID 不同，标签不支持唯一性，反而通常希望许多对象携带相同的标签，此时，可以通过标签选择算法来识别一组对象，一个用例，确定节点集，方便`Pod`调度。

# 参考资料

- https://kubernetes.io/zh-cn/docs/
- https://yeasy.gitbook.io/docker_practice/kubernetes
- https://www.redhat.com/en/topics/containers/what-is-kubernetes